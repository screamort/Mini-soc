FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV WAZUH_MANAGER="wazuh-manager"

# Install dependencies
RUN apt-get update && apt-get install -y \
    curl \
    apt-transport-https \
    lsb-release \
    gnupg \
    ca-certificates \
    auditd \
    openssh-server \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Install Wazuh agent
RUN curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH | apt-key add - && \
    echo "deb https://packages.wazuh.com/4.x/apt/ stable main" | tee /etc/apt/sources.list.d/wazuh.list && \
    apt-get update && \
    apt-get install -y wazuh-agent && \
    rm -rf /var/lib/apt/lists/*

# Configure auditd
COPY auditd-rules.conf /etc/audit/rules.d/mini-soc.rules

# Setup SSH for testing
RUN mkdir /var/run/sshd && \
    echo 'root:testpassword' | chpasswd && \
    sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config

# Configure Wazuh agent
RUN echo "<ossec_config><client><server><address>${WAZUH_MANAGER}</address></server></client></ossec_config>" > /var/ossec/etc/ossec.conf

EXPOSE 22

CMD service auditd start && service ssh start && /var/ossec/bin/wazuh-control start && tail -f /var/ossec/logs/ossec.log
